<script>
(function(){
  // --- Random subtext (with rotation) ---
  const subs = [
    "This might take a few seconds...",
    "Never gonna give you up...",
    "Warming up matrices...",
    "Calibrating color maps...",
    "Sharpening scoring functions...",
    "Bringing the ring to Sauron...",
    "Capturing genomic essence...",
    "Counting available codons...",
    "Trying to generate alien sequences...",
    "404. Error. Motivation not found.",
    "Testing sequence quality...",
    "Perturbing fasta headers...",
    "Coloring nucleotides...",
    "Look at me. I am your new alignment viewer now.",
    "System booting up...",
    "Measuring amino acid properties...",
    "Loading fonts...",
    "Polishing nucleotides...",
    "Shuffling amino acids...",
    "Preparing BLOSUM matrices...",
    "Planning world domination...",
    "Counting gaps (carefully)...",
    "Juggling FASTA files...",
    "Sorting exons from introns...",
    "Preparing the universe...",
    "Assessing chemical properties...",
    "Warming up matplotlib...",
    "Taking a nap...",
    "Calculating the answer to life, the universe, and everything...",
    "42, the answer to life, the universe, and everything.",
    "You are now a MSAexplorer user.",
    "You did it. You are a wizard, Harry.",
    "Holding my breath...",
    "Admiring your beauty...",
    "Life is life. NaNaNaNaNa.",
    "Loading UI..."
  ];
  const subEl = document.querySelector('#splash .sub');
  let rotateId = null;

  if (subEl) {
    let i = Math.floor(Math.random() * subs.length);
    subEl.textContent = subs[i];
    rotateId = setInterval(() => {
      i = (i + 1) % subs.length;
      subEl.textContent = subs[i];
    }, 3000);
  }

  // --- Fade out helper (also stop rotating text) ---
  function fadeOut(){
    const el = document.getElementById("splash");
    if (!el) return;
    if (rotateId) { clearInterval(rotateId); rotateId = null; }
    el.style.opacity = 1;
    (function fade(){
      el.style.opacity -= 0.08;
      if (el.style.opacity <= 0) el.style.display = "none";
      else requestAnimationFrame(fade);
    })();
  }

  // --- Stable idle logic ---
  let busyDepth = 0;
  let hideTimer = null;
  function scheduleHide(delayMs = 1200){
    if (hideTimer) clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
      if (busyDepth === 0) fadeOut();
    }, delayMs);
  }
  function cancelHide(){
    if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
  }

  // Start watching once connected
  document.addEventListener("shiny:connected", () => scheduleHide(), { once:true });
  document.addEventListener("shiny:busy", () => { busyDepth++; cancelHide(); });
  document.addEventListener("shiny:idle", () => {
    busyDepth = Math.max(0, busyDepth - 1);
    if (busyDepth === 0) scheduleHide();
  });

  // Optional: server can hide exactly when ready
  document.addEventListener("DOMContentLoaded", () => {
    if (window.Shiny && Shiny.addCustomMessageHandler) {
      Shiny.addCustomMessageHandler("splash", msg => {
        if (msg && msg.op === "hide") fadeOut();
      });
    }
  });

  // DOM fallback: once #root gets children, *schedule* a hide (don't force immediately)
  const root = document.getElementById("root");
  if (root && "MutationObserver" in window) {
    const mo = new MutationObserver(() => {
      if (root.childElementCount > 0) {
        mo.disconnect();
        scheduleHide();
      }
    });
    mo.observe(root, { childList: true });
  }

  // Last-resort timeout so it never sticks forever
  setTimeout(fadeOut, 30000);
})();
</script>
