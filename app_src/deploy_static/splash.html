<!-- Custom splash overlay (animated, random subtext) -->
<style>
  #splash{
    position:fixed; inset:0; display:grid; place-items:center;
    background:#fff; z-index:99999; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif
  }
  #splash .box{ max-width:560px; text-align:center; padding:24px }
  #splash .title{
    font-size:20px; margin-bottom:6px; opacity:.9;
    animation:fadeInOut 2.4s ease-in-out infinite; will-change:opacity
  }
  #splash .sub{
    font-size:.875rem; /* ~14px */
    color:#6b7280;     /* gray */
    margin-top:4px;
  }
  @keyframes fadeInOut{ 0%{opacity:.2} 50%{opacity:1} 100%{opacity:.2} }
  @media (prefers-reduced-motion: reduce){ #splash .title{ animation:none !important } }
</style>

<div id="splash">
  <div class="box">
    <div class="title">Starting MSAexplorer.</div>
    <div class="sub">This might take a few seconds.</div>
  </div>
</div>

<script>
(function(){
  // Put splash at end of <body> so itâ€™s topmost in DOM order too
  document.addEventListener("DOMContentLoaded", () => {
    const s = document.getElementById("splash");
    if (s && s.parentNode === document.body) document.body.appendChild(s);
  });

  // --- Random subtext with rotation ---
  const subs = [
    "This might take a few seconds...",
    "Never gonna give you up...",
    "Warming up matrices...",
    "Calibrating color maps...",
    "Sharpening scoring functions...",
    "Bringing the ring to Sauron...",
    "Capturing genomic essence...",
    "Counting available codons...",
    "Trying to generate alien sequences...",
    "404. Error. Motivation not found.",
    "Testing sequence quality...",
    "Perturbing fasta headers...",
    "Coloring nucleotides...",
    "Look at me. I am your new alignment viewer now.",
    "System booting up...",
    "Measuring amino acid properties...",
    "Loading fonts...",
    "Polishing nucleotides...",
    "Shuffling amino acids...",
    "Preparing BLOSUM matrices...",
    "Planning world domination...",
    "Counting gaps (carefully)...",
    "Juggling FASTA files...",
    "Sorting exons from introns...",
    "Preparing the universe...",
    "Assessing chemical properties...",
    "Warming up matplotlib...",
    "Taking a nap...",
    "Calculating the answer to life, the universe, and everything...",
    "42, the answer to life, the universe, and everything.",
    "You are now a MSAexplorer user.",
    "You did it. You are a wizard, Harry.",
    "Holding my breath...",
    "Admiring your beauty...",
    "Life is life. NaNaNaNaNa.",
    "Loading UI..."
  ];
  const subEl = document.querySelector('#splash .sub');
  let rotateId = null;
  if (subEl) {
    let i = Math.floor(Math.random() * subs.length);
    subEl.textContent = subs[i];
    rotateId = setInterval(() => {
      i = (i + 1) % subs.length;
      subEl.textContent = subs[i];
    }, 3000);
  }

  // --- Fade out helper ---
  function fadeOut(){
    const el = document.getElementById("splash");
    if (!el) return;
    if (rotateId) { clearInterval(rotateId); rotateId = null; }
    el.style.opacity = 1;
    (function fade(){
      el.style.opacity -= 0.08;
      if (el.style.opacity <= 0) el.style.display = "none";
      else requestAnimationFrame(fade);
    })();
  }

  // --- Stable idle based on <body>.classList contains 'shiny-busy' ---
  let hideTimer = null;
  function scheduleHide(delayMs = 1200){
    if (hideTimer) clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
      if (!document.body.classList.contains("shiny-busy")) fadeOut();
    }, delayMs);
  }
  function cancelHide(){
    if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
  }

  // Observe changes to body.class (busy/idle flips)
  const bodyObserver = new MutationObserver(muts => {
    for (const m of muts) {
      if (m.attributeName === "class") {
        if (document.body.classList.contains("shiny-busy")) {
          cancelHide();                      // went busy again
        } else {
          scheduleHide();                    // now idle; wait a bit to be sure
        }
      }
    }
  });
  bodyObserver.observe(document.body, { attributes: true });

  // If the Shiny events are available, use them to kick-start the process
  document.addEventListener("shiny:connected", () => scheduleHide(), { once:true });
  document.addEventListener("shiny:idle", () => scheduleHide());
  document.addEventListener("shiny:busy", () => cancelHide());

  // Safety timeout (never stick forever)
  //setTimeout(fadeOut, 30000);
})();
</script>
